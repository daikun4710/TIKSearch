<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <link rel="stylesheet" href="./css/sample.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <title>Google Map with Info Window and Link</title>
    <style>
      #map {
        height: 500px;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var map;
      var infoWindow;

      function initMap() {
        // マップを表示するためのオプションを設定
        var mapOptions = {
          center: { lat: 0, lng: 0 }, // マップの初期中心位置
          zoom: 15, // ズームレベル（1が最小、20が最大）
        };
        // 地図を作成
        var map = new google.maps.Map(
          document.getElementById("map"),
          mapOptions
        );
        // ユーザーの現在位置を取得して地図上に表示
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              var userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };

              // ユーザーの位置にマーカーを追加
              new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "現在の位置",
              });

              // マップをユーザーの位置に移動
              map.setCenter(userLocation);
              map.setZoom(15);
            },
            function (error) {
              // エラーメッセージを表示
              console.error(
                "位置情報を取得できませんでした。エラー: " + error.message
              );
            }
          );
        } else {
          // ブラウザが位置情報をサポートしていない場合のメッセージ
          console.error("このブラウザは位置情報をサポートしていません。");
        }

        // 情報ウィンドウを初期化
        infoWindow = new google.maps.InfoWindow();

        // ピンを立てたい住所
        const addressesData = JSON.parse(localStorage.getItem("Addresses"));
        //addressesData の中の　addresses を取り出す
        let addresses = addressesData.addresses;
        // ジオコーディングを実行
        var geocoder = new google.maps.Geocoder();
        // 4 つごとにまとまっていると仮定してループ
        for (let i = 0; i < addresses.length; i += 4) {
            let address = addresses[i];//住所
            let currentID = addresses[i + 1]; //動画ID
            let currentUsername = addresses[i + 2];//ユーザー名
            let currentThumbnail = addresses[i + 3];//サムネイルurls

            geocoder.geocode({ address: address }, function (results, status) {
            if (status === "OK") {
                var location = results[0].geometry.location;

                // ピンを作成
                var marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    title: address,
                });

                // 詳細情報ウィンドウの内容
                var contentString =
                    '<div class="card"><div class="card_imgframe">'+
                    '<a href="' +currentThumbnail + '"data-lightbox="image" data-title="画像の説明">' +
                    '<img  src="' +currentThumbnail+'" alt="No image"></a></div>'+
                    '<div class="card_textbox"><div class="card_titletext"><a href="https://www.tiktok.com/@'
                      +currentUsername+'/video/'+currentID+'" target="_blank"><p style="color: red; font-size: 20px; font-weight: 500;">動画を見る<img src="./image/再生マーク.png" style="width: 30px; height: 30px; border:  none; margin-bottom: 2px;" ></p></a><hr style="margin: 10px; opacity: 0.3; color: blue; border-bottom: outset;"></div>'+
                    '<div class="card_overviewtext">'+address+'</div>'
                    '</div></div>';

                // ピンをクリックしたときのイベントリスナー
                marker.addListener("click", function () {
                    // 詳細情報ウィンドウに内容をセット
                    infoWindow.setContent(contentString);

                    // ピンの位置にウィンドウを表示
                    infoWindow.open(map, marker);
                });
            } else {
                // alert("ジオコーディングに失敗しました: " + status);
            }
        });
        }

      }
      var dataArray = JSON.parse(localStorage.getItem("Addresses"));
      //検索情報出力
      console.log(dataArray);
    </script>

    <script
      async
      defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUqiDP-1T8cxCyJRYrel2GIcAlz5_vgAE&callback=initMap"
    ></script>
    <py-script> print(19) </py-script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  </body>
</html>
