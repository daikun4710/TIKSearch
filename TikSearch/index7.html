<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta name="viewport" content="width=device-width,intial-scale=1"/>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <link rel="stylesheet" href="./css/map.css">
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <!-- ApiKeyãŒã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ -->
    <script type="text/javascript" src="js/mapApiKey.js"></script>
    <script type="text/javascript" src="js/reSearch.js"></script>
    <title>Google Map with Info Window and Link</title>
    <style>
      #map {
        height: 400px;
        width: 100%;
      }
      body{
      margin:0;
      }
      #map {
        height: 400px;
        width: 100%;
      }

      #addressesList {
        max-height: 250px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªé ˜åŸŸã®æœ€å¤§ã®é«˜ã• */
        overflow-y: auto; /* ç¸¦æ–¹å‘ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ */
        margin: 10px;
      }

      .serach {
        /* position: absolute; */
        top: 380px;
        left: 10px;
        font-size: 25px;
      }

      ul {
        counter-reset: number;
        /* ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ */
        list-style-type: none !important;
        /* ç•ªå·ã‚’æ¶ˆã™ */
        padding: 0.3em 0.8em;
        border: solid 2px #ffb107;
      }
      ul li {
        border-bottom: dashed 1px orange;
        position: relative;
        padding: 0.5em 0.5em 0.5em 30px;
        line-height: 1.5em;
        counter-increment: number;
        /* å„liè¦ç´ ã”ã¨ã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å¢—ã‚„ã™ */
      }

      ul li:after {
        /* ã“ã“ã§ç•ªå·ã‚’æŒ‡å®š */
        position: absolute;
        content: counter(number);
        /* ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®å€¤ã‚’è¡¨ç¤º */
        /* ç•ªå·ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        display: inline-block;
        background: #ffb107;
        color: white;
        font-family: 'Avenir', 'Arial Black', 'Arial', sans-serif;
        font-weight: bold;
        font-size: 15px;
        border-radius: 50%;
        left: 0;
        width: 25px;
        height: 25px;
        line-height: 25px;
        text-align: center;
        /* ç¸¦æ–¹å‘ã®ä¸­å¤®æƒãˆ */
        top: 50%;
        -webkit-transform: translateY(-50%);
        transform: translateY(-50%);
      }
      ul li:last-of-type {
        border-bottom: none;
        /* æœ€å¾Œã®liã®ç·šã ã‘æ¶ˆã™ */
      }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
  </head>
  <body>
    
    <div id="search-box-container" class="flex_test-box">
      <div class="flex_test-item">
        <form action="#">
          <!-- <label for="category">ã‚«ãƒ†ã‚´ãƒª</label> -->
          <select id="category">
            <option value="è¦³å…‰">è¦³å…‰</option>
            <option value="ã‚°ãƒ«ãƒ¡">ã‚°ãƒ«ãƒ¡</option>
          </select>
        </form>
      </div>
    
      <div class="flex_test-item">
        <!-- <label for="place">çœŒ</label> -->
        <select name="place" id="place">
          <!-- éƒ½é“åºœçœŒã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
          <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
          <option value="é’æ£®">é’æ£®çœŒ</option>
          <option value="ç§‹ç”°">ç§‹ç”°çœŒ</option>
          <option value="å²©æ‰‹">å²©æ‰‹çœŒ</option>
          <option value="å®®åŸ">å®®åŸçœŒ</option>
          <option value="å±±å½¢">å±±å½¢çœŒ</option>
          <option value="ç¦å³¶">ç¦å³¶çœŒ</option>
          <option value="æ±äº¬">æ±äº¬éƒ½</option>
          <option value="åƒè‘‰">åƒè‘‰çœŒ</option>
          <option value="åŸ¼ç‰">åŸ¼ç‰çœŒ</option>
          <option value="ç¥å¥ˆå·">ç¥å¥ˆå·çœŒ</option>
          <option value="ç¾¤é¦¬">ç¾¤é¦¬çœŒ</option>
          <option value="æ ƒæœ¨">æ ƒæœ¨çœŒ</option>
          <option value="èŒ¨åŸ">èŒ¨åŸçœŒ</option>
          <option value="æ–°æ½Ÿ">æ–°æ½ŸçœŒ</option>
          <option value="å±±æ¢¨">å±±æ¢¨çœŒ</option>
          <option value="é™å²¡">é™å²¡çœŒ</option>
          <option value="é•·é‡">é•·é‡çœŒ</option>
          <option value="å²é˜œ">å²é˜œçœŒ</option>
          <option value="æ„›çŸ¥">æ„›çŸ¥çœŒ</option>
          <option value="å¯Œå±±">å¯Œå±±çœŒ</option>
          <option value="çŸ³å·">çŸ³å·çœŒ</option>
          <option value="ç¦äº•">ç¦äº•çœŒ</option>
          <option value="äº¬éƒ½">äº¬éƒ½åºœ</option>
          <option value="å¤§é˜ª">å¤§é˜ªåºœ</option>
          <option value="æ»‹è³€">æ»‹è³€çœŒ</option>
          <option value="å…µåº«">å…µåº«çœŒ</option>
          <option value="å¥ˆè‰¯">å¥ˆè‰¯çœŒ</option>
          <option value="å’Œæ­Œå±±">å’Œæ­Œå±±çœŒ</option>
          <option value="ä¸‰é‡">ä¸‰é‡çœŒ</option>
          <option value="é³¥å–">é³¥å–çœŒ</option>
          <option value="å³¶æ ¹">å³¶æ ¹çœŒ</option>
          <option value="å²¡å±±">å²¡å±±çœŒ</option>
          <option value="åºƒå³¶">åºƒå³¶çœŒ</option>
          <option value="å±±å£">å±±å£çœŒ</option>
          <option value="æ„›åª›">æ„›åª›çœŒ</option>
          <option value="é«˜çŸ¥">é«˜çŸ¥çœŒ</option>
          <option value="å¾³å³¶">å¾³å³¶çœŒ</option>
          <option value="é¦™å·">é¦™å·çœŒ</option>
          <option value="ç¦å²¡">ç¦å²¡çœŒ</option>
          <option value="ä½è³€">ä½è³€çœŒ</option>
          <option value="é•·å´">é•·å´çœŒ</option>
          <option value="ç†Šæœ¬">ç†Šæœ¬çœŒ</option>
          <option value="å¤§åˆ†">å¤§åˆ†çœŒ</option>
          <option value="å®®å´">å®®å´çœŒ</option>
          <option value="é¹¿å…å³¶">é¹¿å…å³¶çœŒ</option>
          <option value="æ²–ç¸„">æ²–ç¸„çœŒ</option>
        </select>
      </div>
    
      <div class="flex_test-item">
        <button type="button" class="btn btn-primary" onclick="startReLoading()">æ¤œç´¢</button>
      </div>
      <div class="flex_test-item">
        <div id="loadingMessage" style="color:rgb(34,58,112);display: none;font-size: 30px;font-family: Hiragino Sans,ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ã‚·ãƒƒã‚¯; font-weight: 600;">å®Ÿè¡Œä¸­...
          <img src="image/Walk-unscreen.gif" alt="Loading..." width="50">
        </div>
      </div>
    </div>

    <div id="map"></div>
    
    <p class="serach">æ¤œç´¢ä¸€è¦§ğŸ”</p>
    <div>
      <ul id="addressesList">
      </ul>
    </div>
    <script>
      var map;
      var infoWindow;
      function initMap() {
      // ãƒãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
      var mapOptions = {
        center: { lat: 0, lng: 0 }, // ãƒãƒƒãƒ—ã®åˆæœŸä¸­å¿ƒä½ç½®
        zoom: 15, // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ï¼ˆ1ãŒæœ€å°ã€20ãŒæœ€å¤§ï¼‰
      };
      // åœ°å›³ã‚’ä½œæˆ
      map = new google.maps.Map(
        document.getElementById("map"),
        mapOptions
      );
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾åœ¨ä½ç½®ã‚’å–å¾—ã—ã¦åœ°å›³ä¸Šã«è¡¨ç¤º
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function (position) {
            var userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½ç½®ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            new google.maps.Marker({
              position: userLocation,
              map: map,
              title: "ç¾åœ¨ã®ä½ç½®",
            });
            // ãƒãƒƒãƒ—ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½ç½®ã«ç§»å‹•
            map.setCenter(userLocation);
            map.setZoom(15);
          },
          function (error) {
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            console.error(
              "ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼: " + error.message
            );
          }
        );
      } else {
        // ãƒ–ãƒ©ã‚¦ã‚¶ãŒä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        console.error("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
      }
      // æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’åˆæœŸåŒ–
      infoWindow = new google.maps.InfoWindow();

        // ãƒ”ãƒ³ã‚’ç«‹ã¦ãŸã„ä½æ‰€
        const addressesData = JSON.parse(localStorage.getItem("Addresses"));
        //addressesData ã®ä¸­ã®ã€€addresses ã‚’å–ã‚Šå‡ºã™
        let addresses = addressesData.addresses;
        // Log and display each address in the array
        var addressesList = document.getElementById("addressesList");
        // ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å®Ÿè¡Œ
        var geocoder = new google.maps.Geocoder();
        // 4 ã¤ã”ã¨ã«ã¾ã¨ã¾ã£ã¦ã„ã‚‹ã¨ä»®å®šã—ã¦ãƒ«ãƒ¼ãƒ—
        for (let i = 0; i < addresses.length; i += 4) {
            let address = addresses[i];//ä½æ‰€
            let currentID = addresses[i + 1]; //å‹•ç”»ID
            let currentUsername = addresses[i + 2];//ãƒ¦ãƒ¼ã‚¶ãƒ¼å
            let currentThumbnail = addresses[i + 3];//ã‚µãƒ ãƒã‚¤ãƒ«url
            // Display addresses as a list
            const maxLength = 300; // è¡¨ç¤ºã™ã‚‹æœ€å¤§æ–‡å­—æ•°
            let truncatedAddress = address; // ã“ã“ã«çŸ­ç¸®ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’æ ¼ç´ã™ã‚‹

            // æ–‡å­—åˆ—ã®é•·ã•ãŒæœ€å¤§æ–‡å­—æ•°ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã€çŸ­ç¸®ã™ã‚‹
            if (address.length > maxLength) {
              truncatedAddress = address.substring(0, maxLength) + '...';
            }

            addressesList.innerHTML += '<li style="display: flex; align-items: center;"><img src="' + currentThumbnail
                                      + '" alt="ã‚µãƒ ãƒã‚¤ãƒ«" height="200"><div style="height:200px; margin-left: 10px; display: flex; align-items: center;"><span style="text-align: center; width: 100%;">' + truncatedAddress + '</span></div></li>';

            // console.log("Address " + (i + 1) + ": " + addressArray[i]);
            geocoder.geocode({ address: address }, function (results, status) {
            if (status === "OK") {
                var location = results[0].geometry.location;
                // å ´æ‰€ã®ç²¾åº¦ã‚’å–å¾—
                const locationType = results[0].geometry.location_type;
                if (locationType==='ROOFTOP'||locationType==='RANGE_INTERPOLATED') {
                  // ãƒ”ãƒ³ã‚’ä½œæˆ
                  var marker = new google.maps.Marker({
                      position: location,
                      map: map,
                      title: address,
                  });

                  // è©³ç´°æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å†…å®¹
                  var contentString =
                      "<div><h3>" +
                      address +
                      '</h3><p><a href="https://www.tiktok.com/@'+
                        currentUsername+'/video/'+
                        currentID+'" target="_blank">ã‚µã‚¤ãƒˆã¸ã®ãƒªãƒ³ã‚¯</a></p><p><img src="'
                          +currentThumbnail+'" alt="ã‚µãƒ ãƒã‚¤ãƒ«" height="320"></p>'+
                          locationType+'</div>';

                  // ãƒ”ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                  marker.addListener("click", function () {
                      // è©³ç´°æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«å†…å®¹ã‚’ã‚»ãƒƒãƒˆ
                      infoWindow.setContent(contentString);

                      // ãƒ”ãƒ³ã®ä½ç½®ã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º
                      infoWindow.open(map, marker);
                  });
                }
            }
        });
        }

      }
      // var dataArray = JSON.parse(localStorage.getItem("Addresses"));
      // æ¤œç´¢æƒ…å ±å‡ºåŠ›
      // console.log(dataArray);
      // Google Maps API ã® API ã‚­ãƒ¼ã‚’å–å¾—
      const googleMapsApiKey = config.mapApiKey;
      //ApiKeyã€€scriptä½œæˆ
      const mapApiScript = document.createElement("script");
      mapApiScript.src = "https://maps.googleapis.com/maps/api/js?key="+googleMapsApiKey+"&callback=initMap";
      mapApiScript.async = true;
      mapApiScript.defer = true;
      document.head.appendChild(mapApiScript);
    </script>
  </body>
</html>

